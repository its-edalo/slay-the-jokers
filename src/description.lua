BASE_GAME_CARDS = {["8 Ball"] = true, ["Abstract Joker"] = true, ["Acrobat"] = true, ["Ancient Joker"] = true, ["Arrowhead"] = true, ["Astronomer"] = true, ["Banner"] = true, ["Baron"] = true, ["Baseball Card"] = true, ["Blackboard"] = true, ["Bloodstone"] = true, ["Blue Joker"] = true, ["Blueprint"] = true, ["Bootstraps"] = true, ["Brainstorm"] = true, ["Bull"] = true, ["Burglar"] = true, ["Burnt Joker"] = true, ["Business Card"] = true, ["Caino"] = true, ["Campfire"] = true, ["Card Sharp"] = true, ["Cartomancer"] = true, ["Castle"] = true, ["Cavendish"] = true, ["Ceremonial Dagger"] = true, ["Certificate"] = true, ["Chaos the Clown"] = true, ["Chicot"] = true, ["Clever Joker"] = true, ["Cloud 9"] = true, ["Constellation"] = true, ["Crafty Joker"] = true, ["Crazy Joker"] = true, ["Credit Card"] = true, ["Delayed Gratification"] = true, ["Devious Joker"] = true, ["Diet Cola"] = true, ["DNA"] = true, ["Driver's License"] = true, ["Droll Joker"] = true, ["Drunkard"] = true, ["The Duo"] = true, ["Dusk"] = true, ["Egg"] = true, ["Erosion"] = true, ["Even Steven"] = true, ["Faceless Joker"] = true, ["The Family"] = true, ["Fibonacci"] = true, ["Flash Card"] = true, ["Flower Pot"] = true, ["Fortune Teller"] = true, ["Four Fingers"] = true, ["Gift Card"] = true, ["Glass Joker"] = true, ["Gluttonous Joker"] = true, ["Golden Joker"] = true, ["Greedy Joker"] = true, ["Green Joker"] = true, ["Gros Michel"] = true, ["Hack"] = true, ["Half Joker"] = true, ["Hallucination"] = true, ["Hanging Chad"] = true, ["Hiker"] = true, ["Hit the Road"] = true, ["Hologram"] = true, ["Ice Cream"] = true, ["The Idol"] = true, ["Invisible Joker"] = true, ["Joker"] = true, ["Jolly Joker"] = true, ["Juggler"] = true, ["Loyalty Card"] = true, ["Luchador"] = true, ["Lucky Cat"] = true, ["Lusty Joker"] = true, ["Mad Joker"] = true, ["Madness"] = true, ["Mail-In Rebate"] = true, ["Marble Joker"] = true, ["Matador"] = true, ["Merry Andy"] = true, ["Midas Mask"] = true, ["Mime"] = true, ["Misprint"] = true, ["Mr. Bones"] = true, ["Mystic Summit"] = true, ["Obelisk"] = true, ["Odd Todd"] = true, ["Onyx Agate"] = true, ["Oops! All 6s"] = true, ["The Order"] = true, ["Pareidolia"] = true, ["Perkeo"] = true, ["Photograph"] = true, ["Popcorn"] = true, ["Raised Fist"] = true, ["Ramen"] = true, ["Red Card"] = true, ["Reserved Parking"] = true, ["Ride the Bus"] = true, ["Riff-raff"] = true, ["Showman"] = true, ["Rocket"] = true, ["Rough Gem"] = true, ["Runner"] = true, ["Satellite"] = true, ["Scary Face"] = true, ["Scholar"] = true, ["Seance"] = true, ["Seeing Double"] = true, ["Seltzer"] = true, ["Shoot the Moon"] = true, ["Shortcut"] = true, ["Sixth Sense"] = true, ["Sly Joker"] = true, ["Smeared Joker"] = true, ["Smiley Face"] = true, ["Sock and Buskin"] = true, ["Space Joker"] = true, ["Splash"] = true, ["Square Joker"] = true, ["Steel Joker"] = true, ["Joker Stencil"] = true, ["Stone Joker"] = true, ["Stuntman"] = true, ["Supernova"] = true, ["Superposition"] = true, ["Swashbuckler"] = true, ["Throwback"] = true, ["Golden Ticket"] = true, ["To the Moon"] = true, ["To Do List"] = true, ["Trading Card"] = true, ["The Tribe"] = true, ["Triboulet"] = true, ["The Trio"] = true, ["Troubadour"] = true, ["Spare Trousers"] = true, ["Turtle Bean"] = true, ["Vagabond"] = true, ["Vampire"] = true, ["Walkie Talkie"] = true, ["Wee Joker"] = true, ["Wily Joker"] = true, ["Wrathful Joker"] = true, ["Yorick"] = true, ["Zany Joker"] = true, ["Ceres"] = true, ["Earth"] = true, ["Eris"] = true, ["Jupiter"] = true, ["Mars"] = true, ["Mercury"] = true, ["Neptune"] = true, ["Planet X"] = true, ["Pluto"] = true, ["Saturn"] = true, ["Uranus"] = true, ["Venus"] = true, ["Ankh"] = true, ["Aura"] = true, ["Black Hole"] = true, ["Cryptid"] = true, ["Deja Vu"] = true, ["Ectoplasm"] = true, ["Familiar"] = true, ["Grim"] = true, ["Hex"] = true, ["Immolate"] = true, ["Incantation"] = true, ["Medium"] = true, ["Ouija"] = true, ["Sigil"] = true, ["The Soul"] = true, ["Talisman"] = true, ["Trance"] = true, ["Wraith"] = true, ["Boss Tag"] = true, ["Buffoon Tag"] = true, ["Charm Tag"] = true, ["Coupon Tag"] = true, ["D6 Tag"] = true, ["Double Tag"] = true, ["Economy Tag"] = true, ["Ethereal Tag"] = true, ["Foil Tag"] = true, ["Garbage Tag"] = true, ["Handy Tag"] = true, ["Holographic Tag"] = true, ["Investment Tag"] = true, ["Juggle Tag"] = true, ["Meteor Tag"] = true, ["Negative Tag"] = true, ["Orbital Tag"] = true, ["Polychrome Tag"] = true, ["Rare Tag"] = true, ["Speed Tag"] = true, ["Standard Tag"] = true, ["Top-up Tag"] = true, ["Uncommon Tag"] = true, ["Voucher Tag"] = true, ["The Chariot"] = true, ["Death"] = true, ["The Devil"] = true, ["The Emperor"] = true, ["The Empress"] = true, ["The Fool"] = true, ["The Hanged Man"] = true, ["The Hierophant"] = true, ["The Hermit"] = true, ["The High Priestess"] = true, ["Judgement"] = true, ["Justice"] = true, ["The Lovers"] = true, ["The Magician"] = true, ["The Moon"] = true, ["The Star"] = true, ["Strength"] = true, ["The Sun"] = true, ["Temperance"] = true, ["The Tower"] = true, ["The Wheel of Fortune"] = true, ["The World"] = true, ["Antimatter"] = true, ["Blank"] = true, ["Clearance Sale"] = true, ["Crystal Ball"] = true, ["Director's Cut"] = true, ["Glow Up"] = true, ["Grabber"] = true, ["Hieroglyph"] = true, ["Hone"] = true, ["Illusion"] = true, ["Liquidation"] = true, ["Magic Trick"] = true, ["Money Tree"] = true, ["Nacho Tong"] = true, ["Observatory"] = true, ["Omen Globe"] = true, ["Overstock"] = true, ["Overstock Plus"] = true, ["Paint Brush"] = true, ["Palette"] = true, ["Petroglyph"] = true, ["Planet Merchant"] = true, ["Planet Tycoon"] = true, ["Recyclomancy"] = true, ["Reroll Glut"] = true, ["Reroll Surplus"] = true, ["Retcon"] = true, ["Seed Money"] = true, ["Tarot Merchant"] = true, ["Tarot Tycoon"] = true, ["Telescope"] = true, ["Wasteful"] = true}

function Card:is_modded()
    return not BASE_GAME_CARDS[self.ability.name]
end

function Card:generate_locvars()
    local card_type = self.ability.set or "None"
    local loc_vars = {}

    if not self.bypass_lock and self.config.center.unlocked ~= false and
    (self.ability.set == 'Joker' or self.ability.set == 'Edition' or self.ability.consumeable or self.ability.set == 'Voucher' or self.ability.set == 'Booster') and
    not self.config.center.discovered and 
    ((self.area ~= G.jokers and self.area ~= G.consumeables and self.area) or not self.area) then
        card_type = 'Undiscovered'
    end    
    if self.config.center.unlocked == false and not self.bypass_lock then --For everyting that is locked
        card_type = "Locked"
        if self.area and self.area == G.shop_demo then loc_vars = {}; end
    -- elseif self.debuff then
        -- loc_vars = { debuffed = true, playing_card = not not self.base.colour, value = self.base.value, suit = self.base.suit, colour = self.base.colour }
    elseif card_type == 'Default' or card_type == 'Enhanced' then
        loc_vars = { playing_card = not not self.base.colour, value = self.base.value, suit = self.base.suit, colour = self.base.colour,
                    nominal_chips = self.base.nominal > 0 and self.base.nominal or nil,
                    bonus_chips = (self.ability.bonus + (self.ability.perma_bonus or 0)) > 0 and (self.ability.bonus + (self.ability.perma_bonus or 0)) or nil,
                }
    elseif self.ability.set == 'Joker' then
        if self.ability.name == 'Joker' then loc_vars = {self.ability.mult}
        elseif self.ability.name == 'Jolly Joker' or self.ability.name == 'Zany Joker' or
            self.ability.name == 'Mad Joker' or self.ability.name == 'Crazy Joker'  or 
            self.ability.name == 'Droll Joker' then 
            loc_vars = {self.ability.t_mult, localize(self.ability.type, 'poker_hands')}
        elseif self.ability.name == 'Sly Joker' or self.ability.name == 'Wily Joker' or
        self.ability.name == 'Clever Joker' or self.ability.name == 'Devious Joker'  or 
        self.ability.name == 'Crafty Joker' then 
            loc_vars = {self.ability.t_chips, localize(self.ability.type, 'poker_hands')}
        elseif self.ability.name == 'Half Joker' then loc_vars = {self.ability.extra.mult, self.ability.extra.size}
        elseif self.ability.name == 'Fortune Teller' then loc_vars = {self.ability.extra, (G.GAME.consumeable_usage_total and G.GAME.consumeable_usage_total.tarot or 0)}
        elseif self.ability.name == 'Steel Joker' then loc_vars = {self.ability.extra, 1 + self.ability.extra*(self.ability.steel_tally or 0)}
        elseif self.ability.name == 'Chaos the Clown' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Space Joker' then loc_vars = {''..(G.GAME and G.GAME.probabilities.normal or 1), self.ability.extra}
        elseif self.ability.name == 'Stone Joker' then loc_vars = {self.ability.extra, self.ability.extra*(self.ability.stone_tally or 0)}
        elseif self.ability.name == 'Drunkard' then loc_vars = {self.ability.d_size}
        elseif self.ability.name == 'Green Joker' then loc_vars = {self.ability.extra.hand_add, self.ability.extra.discard_sub, self.ability.mult}
        elseif self.ability.name == 'Credit Card' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Greedy Joker' or self.ability.name == 'Lusty Joker' or
            self.ability.name == 'Wrathful Joker' or self.ability.name == 'Gluttonous Joker' then loc_vars = {self.ability.extra.s_mult, localize(self.ability.extra.suit, 'suits_singular')}
        elseif self.ability.name == 'Blue Joker' then loc_vars = {self.ability.extra, self.ability.extra*((G.deck and G.deck.cards) and #G.deck.cards or 52)}
        elseif self.ability.name == 'Sixth Sense' then loc_vars = {}
        elseif self.ability.name == 'Hack' then loc_vars = {self.ability.extra+1}
        elseif self.ability.name == 'Faceless Joker' then loc_vars = {self.ability.extra.dollars, self.ability.extra.faces}
        elseif self.ability.name == 'Juggler' then loc_vars = {self.ability.h_size}
        elseif self.ability.name == 'Golden Joker' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Joker Stencil' then loc_vars = {self.ability.x_mult}
        elseif self.ability.name == 'Ceremonial Dagger' then loc_vars = {self.ability.mult}
        elseif self.ability.name == 'Banner' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Misprint' then
        elseif self.ability.name == 'Mystic Summit' then loc_vars = {self.ability.extra.mult, self.ability.extra.d_remaining}
        elseif self.ability.name == 'Loyalty Card' then loc_vars = {self.ability.extra.Xmult, self.ability.extra.every + 1, localize{type = 'variable', key = (self.ability.loyalty_remaining == 0 and 'loyalty_active' or 'loyalty_inactive'), vars = {self.ability.loyalty_remaining}}}
        elseif self.ability.name == '8 Ball' then loc_vars = {''..(G.GAME and G.GAME.probabilities.normal or 1),self.ability.extra}
        elseif self.ability.name == 'Dusk' then loc_vars = {self.ability.extra+1}
        elseif self.ability.name == 'Fibonacci' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Scary Face' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Abstract Joker' then loc_vars = {self.ability.extra, (G.jokers and G.jokers.cards and #G.jokers.cards or 0)*self.ability.extra}
        elseif self.ability.name == 'Delayed Gratification' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Gros Michel' then loc_vars = {self.ability.extra.mult, ''..(G.GAME and G.GAME.probabilities.normal or 1), self.ability.extra.odds}
        elseif self.ability.name == 'Even Steven' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Odd Todd' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Scholar' then loc_vars = {self.ability.extra.mult, self.ability.extra.chips}
        elseif self.ability.name == 'Business Card' then loc_vars = {''..(G.GAME and G.GAME.probabilities.normal or 1), self.ability.extra}
        elseif self.ability.name == 'Spare Trousers' then loc_vars = {self.ability.extra, localize('Two Pair', 'poker_hands'), self.ability.mult}
        elseif self.ability.name == 'Superposition' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Ride the Bus' then loc_vars = {self.ability.extra, self.ability.mult}
        elseif self.ability.name == 'Egg' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Burglar' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Blackboard' then loc_vars = {self.ability.extra, localize('Spades', 'suits_plural'), localize('Clubs', 'suits_plural')}
        elseif self.ability.name == 'Runner' then loc_vars = {self.ability.extra.chips, self.ability.extra.chip_mod}
        elseif self.ability.name == 'Ice Cream' then loc_vars = {self.ability.extra.chips, self.ability.extra.chip_mod}
        elseif self.ability.name == 'DNA' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Constellation' then loc_vars = {self.ability.extra, self.ability.x_mult}
        elseif self.ability.name == 'Hiker' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'To Do List' then loc_vars = {self.ability.extra.dollars, localize(self.ability.to_do_poker_hand, 'poker_hands')}
        elseif self.ability.name == 'Astronomer' then loc_vars = {self.ability.extra}
        
        elseif self.ability.name == 'Golden Ticket' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Mr. Bones' then
        elseif self.ability.name == 'Acrobat' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Sock and Buskin' then loc_vars = {self.ability.extra+1}
        elseif self.ability.name == 'Swashbuckler' then loc_vars = {self.ability.mult}
        elseif self.ability.name == 'Troubadour' then loc_vars = {self.ability.extra.h_size, -self.ability.extra.h_plays}
        elseif self.ability.name == 'Certificate' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Throwback' then loc_vars = {self.ability.extra, self.ability.x_mult}
        elseif self.ability.name == 'Hanging Chad' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Rough Gem' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Bloodstone' then loc_vars = {''..(G.GAME and G.GAME.probabilities.normal or 1), self.ability.extra.odds, self.ability.extra.Xmult}
        elseif self.ability.name == 'Arrowhead' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Onyx Agate' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Glass Joker' then loc_vars = {self.ability.extra, self.ability.x_mult}
        elseif self.ability.name == 'Flower Pot' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Wee Joker' then loc_vars = {self.ability.extra.chips, self.ability.extra.chip_mod}
        elseif self.ability.name == 'Merry Andy' then loc_vars = {self.ability.d_size, self.ability.h_size}
        elseif self.ability.name == 'The Idol' then loc_vars = {self.ability.extra, localize(G.GAME.current_round.idol_card.rank, 'ranks'), localize(G.GAME.current_round.idol_card.suit, 'suits_plural'), colours = {G.C.SUITS[G.GAME.current_round.idol_card.suit]}}
        elseif self.ability.name == 'Seeing Double' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Matador' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Hit the Road' then loc_vars = {self.ability.extra, self.ability.x_mult}
        elseif self.ability.name == 'The Duo' or self.ability.name == 'The Trio'
            or self.ability.name == 'The Family' or self.ability.name == 'The Order' or self.ability.name == 'The Tribe' then loc_vars = {self.ability.x_mult, localize(self.ability.type, 'poker_hands')}
        
        elseif self.ability.name == 'Cavendish' then loc_vars = {self.ability.extra.Xmult, ''..(G.GAME and G.GAME.probabilities.normal or 1), self.ability.extra.odds}
        elseif self.ability.name == 'Card Sharp' then loc_vars = {self.ability.extra.Xmult}
        elseif self.ability.name == 'Red Card' then loc_vars = {self.ability.extra, self.ability.mult}
        elseif self.ability.name == 'Madness' then loc_vars = {self.ability.extra, self.ability.x_mult}
        elseif self.ability.name == 'Square Joker' then loc_vars = {self.ability.extra.chips, self.ability.extra.chip_mod}
        elseif self.ability.name == 'Seance' then loc_vars = {localize(self.ability.extra.poker_hand, 'poker_hands')}
        elseif self.ability.name == 'Riff-raff' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Vampire' then loc_vars = {self.ability.extra, self.ability.x_mult}
        elseif self.ability.name == 'Hologram' then loc_vars = {self.ability.extra, self.ability.x_mult}
        elseif self.ability.name == 'Vagabond' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Baron' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Cloud 9' then loc_vars = {self.ability.extra, self.ability.extra*(self.ability.nine_tally or 0)}
        elseif self.ability.name == 'Rocket' then loc_vars = {self.ability.extra.dollars, self.ability.extra.increase}
        elseif self.ability.name == 'Obelisk' then loc_vars = {self.ability.extra, self.ability.x_mult}
        elseif self.ability.name == 'Photograph' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Gift Card' then  loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Turtle Bean' then loc_vars = {self.ability.extra.h_size, self.ability.extra.h_mod}
        elseif self.ability.name == 'Erosion' then loc_vars = {self.ability.extra, math.max(0,self.ability.extra*(G.playing_cards and (G.GAME.starting_deck_size - #G.playing_cards) or 0)), G.GAME.starting_deck_size}
        elseif self.ability.name == 'Reserved Parking' then loc_vars = {self.ability.extra.dollars, ''..(G.GAME and G.GAME.probabilities.normal or 1), self.ability.extra.odds}
        elseif self.ability.name == 'Mail-In Rebate' then loc_vars = {self.ability.extra, localize(G.GAME.current_round.mail_card.rank, 'ranks')}
        elseif self.ability.name == 'To the Moon' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Hallucination' then loc_vars = {G.GAME.probabilities.normal, self.ability.extra}
        elseif self.ability.name == 'Lucky Cat' then loc_vars = {self.ability.extra, self.ability.x_mult}
        elseif self.ability.name == 'Baseball Card' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Bull' then loc_vars = {self.ability.extra, self.ability.extra*math.max(0,G.GAME.dollars) or 0}
        elseif self.ability.name == 'Diet Cola' then loc_vars = {localize{type = 'name_text', set = 'Tag', key = 'tag_double', nodes = {}}}
        elseif self.ability.name == 'Trading Card' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Flash Card' then loc_vars = {self.ability.extra, self.ability.mult}
        elseif self.ability.name == 'Popcorn' then loc_vars = {self.ability.mult, self.ability.extra}
        elseif self.ability.name == 'Ramen' then loc_vars = {self.ability.x_mult, self.ability.extra}
        elseif self.ability.name == 'Ancient Joker' then loc_vars = {self.ability.extra, localize(G.GAME.current_round.ancient_card.suit, 'suits_singular'), colours = {G.C.SUITS[G.GAME.current_round.ancient_card.suit]}}
        elseif self.ability.name == 'Walkie Talkie' then loc_vars = {self.ability.extra.chips, self.ability.extra.mult}
        elseif self.ability.name == 'Seltzer' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Castle' then loc_vars = {self.ability.extra.chip_mod, localize(G.GAME.current_round.castle_card.suit, 'suits_singular'), self.ability.extra.chips, colours = {G.C.SUITS[G.GAME.current_round.castle_card.suit]}}
        elseif self.ability.name == 'Smiley Face' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Campfire' then loc_vars = {self.ability.extra, self.ability.x_mult}
        elseif self.ability.name == 'Stuntman' then loc_vars = {self.ability.extra.chip_mod, self.ability.extra.h_size}
        elseif self.ability.name == 'Invisible Joker' then loc_vars = {self.ability.extra, self.ability.invis_rounds}
        elseif self.ability.name == 'Satellite' then
            local planets_used = 0
            for _, v in pairs(G.GAME.consumeable_usage) do if v.set == 'Planet' then planets_used = planets_used + 1 end end
            loc_vars = {self.ability.extra, planets_used*self.ability.extra}
        elseif self.ability.name == 'Shoot the Moon' then loc_vars = {self.ability.extra}
        elseif self.ability.name == "Driver's License" then loc_vars = {self.ability.extra, self.ability.driver_tally or '0'}
        elseif self.ability.name == 'Bootstraps' then loc_vars = {self.ability.extra.mult, self.ability.extra.dollars, self.ability.extra.mult*math.floor((G.GAME.dollars + (G.GAME.dollar_buffer or 0))/self.ability.extra.dollars)}
        elseif self.ability.name == 'Caino' then loc_vars = {self.ability.extra, self.ability.caino_xmult}
        elseif self.ability.name == 'Triboulet' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Yorick' then loc_vars = {self.ability.extra.xmult, self.ability.extra.discards, self.ability.yorick_discards, self.ability.x_mult}
        elseif self.ability.name == 'Perkeo' then loc_vars = {self.ability.extra}
        end
    elseif self.ability.set == 'Spectral' then 
        if self.ability.name == 'Familiar' or self.ability.name == 'Grim' or self.ability.name == 'Incantation' then loc_vars = {self.ability.extra}
        elseif self.ability.name == 'Immolate' then loc_vars = {self.ability.extra.destroy, self.ability.extra.dollars}
        elseif self.ability.name == 'Cryptid' then loc_vars = {self.ability.extra}
        end
        if self.ability.name == 'Ectoplasm' then loc_vars = {G.GAME.ecto_minus or 1} end
    elseif self.ability.set == 'Planet' then
        loc_vars = {
            G.GAME.hands[self.ability.consumeable.hand_type].level,localize(self.ability.consumeable.hand_type, 'poker_hands'), G.GAME.hands[self.ability.consumeable.hand_type].l_mult, G.GAME.hands[self.ability.consumeable.hand_type].l_chips,
            colours = {(G.GAME.hands[self.ability.consumeable.hand_type].level==1 and G.C.UI.TEXT_DARK or G.C.HAND_LEVELS[math.min(7, G.GAME.hands[self.ability.consumeable.hand_type].level)])}
        }
    elseif self.ability.set == 'Tarot' then
        if self.ability.name == "The Fool" then
            local fool_c = G.GAME.last_tarot_planet and G.P_CENTERS[G.GAME.last_tarot_planet] or nil
            local last_tarot_planet = fool_c and localize{type = 'name_text', key = fool_c.key, set = fool_c.set} or localize('k_none')
            loc_vars = {last_tarot_planet}
        elseif self.ability.name == "The Magician" then loc_vars = {self.ability.consumeable.max_highlighted, localize{type = 'name_text', set = 'Enhanced', key = self.ability.consumeable.mod_conv}}
        elseif self.ability.name == "The High Priestess" then loc_vars = {self.ability.consumeable.planets}
        elseif self.ability.name == "The Empress" then loc_vars = {self.ability.consumeable.max_highlighted, localize{type = 'name_text', set = 'Enhanced', key = self.ability.consumeable.mod_conv}}
        elseif self.ability.name == "The Emperor" then loc_vars = {self.ability.consumeable.tarots}
        elseif self.ability.name == "The Hierophant" then loc_vars = {self.ability.consumeable.max_highlighted, localize{type = 'name_text', set = 'Enhanced', key = self.ability.consumeable.mod_conv}}
        elseif self.ability.name == "The Lovers" then loc_vars = {self.ability.consumeable.max_highlighted, localize{type = 'name_text', set = 'Enhanced', key = self.ability.consumeable.mod_conv}}
        elseif self.ability.name == "The Chariot" then loc_vars = {self.ability.consumeable.max_highlighted, localize{type = 'name_text', set = 'Enhanced', key = self.ability.consumeable.mod_conv}}
        elseif self.ability.name == "Justice" then loc_vars = {self.ability.consumeable.max_highlighted, localize{type = 'name_text', set = 'Enhanced', key = self.ability.consumeable.mod_conv}}
        elseif self.ability.name == "The Hermit" then loc_vars = {self.ability.consumeable.extra}
        elseif self.ability.name == "The Wheel of Fortune" then loc_vars = {G.GAME.probabilities.normal, self.ability.consumeable.extra}
        elseif self.ability.name == "Strength" then loc_vars = {self.ability.consumeable.max_highlighted}
        elseif self.ability.name == "The Hanged Man" then loc_vars = {self.ability.consumeable.max_highlighted}
        elseif self.ability.name == "Death" then loc_vars = {self.ability.consumeable.max_highlighted}
        elseif self.ability.name == "Temperance" then
            local _money = 0
            if G.jokers then
                for i = 1, #G.jokers.cards do
                    if G.jokers.cards[i].ability.set == 'Joker' then
                        _money = _money + G.jokers.cards[i].sell_cost
                    end
                end
            end
            loc_vars = {self.ability.consumeable.extra, math.min(self.ability.consumeable.extra, _money)}
        elseif self.ability.name == "The Devil" then loc_vars = {self.ability.consumeable.max_highlighted, localize{type = 'name_text', set = 'Enhanced', key = self.ability.consumeable.mod_conv}}
        elseif self.ability.name == "The Tower" then loc_vars = {self.ability.consumeable.max_highlighted, localize{type = 'name_text', set = 'Enhanced', key = self.ability.consumeable.mod_conv}}
        elseif self.ability.name == "The Star" then loc_vars = {self.ability.consumeable.max_highlighted,  localize(self.ability.consumeable.suit_conv, 'suits_plural'), colours = {G.C.SUITS[self.ability.consumeable.suit_conv]}}
        elseif self.ability.name == "The Moon" then loc_vars = {self.ability.consumeable.max_highlighted, localize(self.ability.consumeable.suit_conv, 'suits_plural'), colours = {G.C.SUITS[self.ability.consumeable.suit_conv]}}
        elseif self.ability.name == "The Sun" then loc_vars = {self.ability.consumeable.max_highlighted, localize(self.ability.consumeable.suit_conv, 'suits_plural'), colours = {G.C.SUITS[self.ability.consumeable.suit_conv]}}
        elseif self.ability.name == "The World" then loc_vars = {self.ability.consumeable.max_highlighted, localize(self.ability.consumeable.suit_conv, 'suits_plural'), colours = {G.C.SUITS[self.ability.consumeable.suit_conv]}}
        end
    elseif self.ability.set == 'Voucher' then
        if self.ability.name == "Overstock" or self.ability.name == 'Overstock Plus' then
        elseif self.ability.name == "Tarot Merchant" or self.ability.name == "Tarot Tycoon" then loc_vars = {self.config.center.config.extra_disp}
        elseif self.ability.name == "Planet Merchant" or self.ability.name == "Planet Tycoon" then loc_vars = {self.config.center.config.extra_disp}
        elseif self.ability.name == "Hone" or self.ability.name == "Glow Up" then loc_vars = {self.config.center.config.extra}
        elseif self.ability.name == "Reroll Surplus" or self.ability.name == "Reroll Glut" then loc_vars = {self.config.center.config.extra}
        elseif self.ability.name == "Grabber" or self.ability.name == "Nacho Tong" then loc_vars = {self.config.center.config.extra}
        elseif self.ability.name == "Wasteful" or self.ability.name == "Recyclomancy" then loc_vars = {self.config.center.config.extra}
        elseif self.ability.name == "Seed Money" or self.ability.name == "Money Tree" then loc_vars = {self.config.center.config.extra/5}
        elseif self.ability.name == "Blank" or self.ability.name == "Antimatter" then
        elseif self.ability.name == "Hieroglyph" or self.ability.name == "Petroglyph" then loc_vars = {self.config.center.config.extra}
        elseif self.ability.name == "Director's Cut" or self.ability.name == "Retcon" then loc_vars = {self.config.center.config.extra}
        elseif self.ability.name == "Paint Brush" or self.ability.name == "Palette" then loc_vars = {self.config.center.config.extra}
        elseif self.ability.name == "Telescope" or self.ability.name == "Observatory" then loc_vars = {self.config.center.config.extra}
        elseif self.ability.name == "Clearance Sale" or self.ability.name == "Liquidation" then loc_vars = {self.config.center.config.extra}
        end
    end

    return loc_vars
end

function Card:get_popup_direction()
    if self.ability.set == 'Voucher' then
        return 'l'
    end
    return (self.children.buy_button or (self.area and self.area.config.view_deck) or (self.area and self.area.config.type == 'shop')) and 'l' or
            (self.T.y < G.CARD_H*0.8) and 'b' or
            't'
end

function Card:get_parsed_text(main_table)
    local str = ""
    local line_count = #main_table
    for i, line in pairs(main_table) do
        for _, part in pairs(line) do
            -- Note - The lovely DLL itself changes `localize`! Don't rely on the source code alone.
            if part.config then
                if part.config.text then
                    str = str .. part.config.text
                end
            end
            if part.nodes and #part.nodes > 0 and part.nodes[1].config then
                if part.nodes[1].config.text then
                    str = str .. part.nodes[1].config.text
                elseif part.nodes[1].config.object and part.nodes[1].config.object.string then
                    str = str .. part.nodes[1].config.object.string
                end
            end
        end
        if i < line_count then
            str = str .. "\\n"
        end
    end
    return str
end

function colourToJson(colour)
    local function toHex(v)
        return string.format("%02x", math.floor(v * 255 + 0.5))
    end

    if not colour or type(colour) ~= 'table' or #colour < 3 then
        return nil
    end

    local r = toHex(colour[1] or 0)
    local g = toHex(colour[2] or 0)
    local b = toHex(colour[3] or 0)
    local a = toHex(colour[4] == nil and 1 or colour[4])
    return "#" .. r .. g .. b .. a
end

function Card:get_text_parts(main_table)
    local parts_table = {}
    local line_count = #main_table
    for i, line in pairs(main_table) do
        if line and type(line) == 'table' then
            for _, part in pairs(line) do
                -- Note - The lovely DLL itself changes `localize`! Don't rely on the source code alone.
                local parsed_part = nil
                local bg = nil
                if part.config then
                    if part.config.text then
                        parsed_part = {["t"] = part.config.text, ["c"] = colourToJson(part.config.colour)}
                    elseif part.config.colour then
                        bg = colourToJson(part.config.colour)
                    end
                end
                if not parsed_part and part.nodes and #part.nodes > 0 and part.nodes[1].config then
                    local node_config = part.nodes[1].config
                    if node_config.text then
                        parsed_part = {["t"] = node_config.text, ["c"] = colourToJson(node_config.colour)}
                    elseif node_config.object and node_config.object.string then
                        parsed_part = {["t"] = node_config.object.string}

                        local colours = node_config.object.colours
                        if colours and #colours > 0 then
                            parsed_part["c"] = colourToJson(colours[1])
                        end
                    end
                end

                if parsed_part and parsed_part["t"] and type(parsed_part["t"]) == 'string' then
                    if bg then
                        parsed_part["b"] = bg
                    end
                    table.insert(parts_table, parsed_part)
                end
            end
            if i < line_count then
                table.insert(parts_table, {["n"] = 1})
            end
        end
    end
    return parts_table
end

function get_string_array(tbl)
    local stbl = {}

    if not tbl then
        return {}
    end

    for k, v in pairs(tbl) do
        if type(k) == 'number' then
            stbl[k] = tostring(v)
        end
    end
    return stbl
end

function Card:get_description_table(is_modded)
    if (is_modded) then
        G.DENY_DYNAMIC_TEXT = true
        local main_table = self:generate_UIBox_ability_table()["main"]
        G.DENY_DYNAMIC_TEXT = false

        if not main_table then
            return {}
        end

        -- text
        -- local desc_table = {["t"] = self:get_parsed_text(main_table)}

        -- parts
        local desc_table = {["p"] = self:get_text_parts(main_table)}
        return desc_table
    else
        -- arguments
        return {["a"] = get_string_array(self:generate_locvars())}
    end
end
